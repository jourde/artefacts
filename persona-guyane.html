<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canevas Persona : L'Enseignant en Guyane</title>
    
    <!-- Performance: Preconnect to font domains and CDN -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Import des Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Import de html2pdf.js pour l'export PDF. 
         Performance: Added 'defer' to prevent blocking DOM parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #475569;
            --border: #e2e8f0;
            
            /* Couleurs spécifiques Guyane */
            --guyane-color: #059669; /* Un vert émeraude */
            --guyane-bg: #ecfdf5;
            --guyane-border: #10b981;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header & Controls */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
            text-align: center;
        }

        h1 {
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
            font-size: 1.5rem;
            margin-top: 0.5rem;
        }

        .subtitle {
            color: var(--secondary);
            max-width: 600px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Styles .controls supprimés car intégrés dans .actions */

        .switch-label {
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            height: 100%; /* Alignement vertical */
        }

        /* The Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--guyane-color);
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }

        /* Actions Buttons */
        .actions {
            margin-top: 1rem;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: stretch;
        }

        .action-group {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            justify-content: space-between;
        }

        .action-group-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 2px;
        }

        .btn-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .btn {
            padding: 8px; /* Plus carré pour les icônes */
            min-width: 36px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative; /* Pour le tooltip */
        }

        .btn .material-icons {
            font-size: 20px;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover {
            background: #eff6ff;
        }

        .btn-reset {
            background: #ef4444;
            color: white;
            border: 1px solid #ef4444;
        }
        .btn-reset:hover {
            background: #dc2626;
        }

        /* Styles pour les Tooltips (Pop-up explicative) */
        .btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            pointer-events: none;
            animation: fadeInTooltip 0.2s ease;
        }

        .btn[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
            z-index: 100;
            pointer-events: none;
            animation: fadeInTooltip 0.2s ease;
        }

        @keyframes fadeInTooltip {
            from { opacity: 0; transform: translate(-50%, 5px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Grid Layout */
        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            page-break-inside: avoid; /* Prevent breaking inside cards when printing */
            /* Performance: contain layout for independent rendering */
            contain: content;
        }

        .card h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin: 0 0 0.2rem 0; /* Reduced margin */
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-desc {
            color: var(--secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        /* Material Icons in Titles */
        .card h2 .material-icons {
            font-size: 1.5rem;
            color: var(--primary);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 0.8rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--text-sub);
        }

        input[type="text"], 
        select, 
        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .checkbox-item input {
            margin-top: 4px;
        }

        /* Context Specific Styling */
        .guyane-context {
            display: none; /* Hidden by default */
            background-color: var(--guyane-bg);
            border-left: 4px solid var(--guyane-border);
            padding: 10px;
            margin-top: 5px;
            border-radius: 0 6px 6px 0;
            animation: fadeIn 0.4s ease;
        }

        .guyane-label {
            color: var(--guyane-color);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
            display: block;
            font-weight: 700;
        }

        body.show-context .guyane-context {
            display: block;
        }

        /* Suggestions Toggle */
        .btn-toggle-suggestions {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0;
            margin-bottom: 0.8rem;
            font-weight: 600;
            width: fit-content;
        }
        .btn-toggle-suggestions:hover {
            text-decoration: underline;
        }
        .suggestions-panel {
            display: none;
            animation: fadeIn 0.3s ease;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
            border-left: 2px solid var(--border);
        }

        
        body.show-suggestions .suggestions-panel {
            display: block;
        }
@keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Footer */
        footer {
            margin-top: 3rem;
            text-align: center;
            color: var(--secondary);
            font-size: 0.8rem;
        }

        /* Modal / Popup Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 2rem;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%; 
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-dark);
        }

        .modal-content p {
            font-size: 0.95rem;
            color: var(--text-main);
        }
        
        .modal-footer {
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: var(--text-sub);
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

    </style>
</head>
<body id="contentToPrint">

    <header>
        <h1>Canevas de Persona pour le personnel d'éducation</h1>
        <div class="subtitle">Prototype pour aider à concevoir des formations adaptées à la réalité terrain.</div>
        
        <!-- Added data-html2canvas-ignore to hide during PDF generation -->
        <div class="actions" data-html2canvas-ignore="true">
            
            <!-- Bloc Contexte -->
            <div class="action-group">
                <span class="action-group-title">Contexte</span>
                <div class="btn-row">
                    <label class="switch-label">
                        <span>Standard</span>
                        <label class="switch">
                            <input type="checkbox" id="contextToggle">
                            <span class="slider"></span>
                        </label>
                        <span style="color: var(--guyane-color);">Guyane</span>
                    </label>
                </div>
            </div>

            
            <!-- Bloc Affichage -->
            <div class="action-group">
                <span class="action-group-title">Affichage</span>
                <div class="btn-row">
                    <label class="switch-label">
                        <span>Suggestions</span>
                        <label class="switch">
                            <input type="checkbox" id="suggestionsToggle">
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
            </div>

<!-- Bloc Gestion -->
            <div class="action-group">
                <span class="action-group-title">Gestion</span>
                <div class="btn-row">
                    <button class="btn btn-reset" onclick="resetForm()" data-tooltip="Réinitialiser le canevas">
                        <span class="material-icons">restart_alt</span>
                    </button>
                </div>
            </div>

            <!-- Bloc Import & Export -->
            <div class="action-group">
                <span class="action-group-title">IMPORT & EXPORT</span>
                <div class="btn-row">
                    <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()" data-tooltip="Charger une sauvegarde (JSON)">
                        <span class="material-icons">upload_file</span>
                    </button>
                    <button class="btn btn-outline" onclick="saveData()" data-tooltip="Sauvegarder (JSON)">
                        <span class="material-icons">save</span>
                    </button>
                    <button class="btn btn-outline" onclick="exportPDF()" data-tooltip="Exporter en PDF">
                        <span class="material-icons">picture_as_pdf</span>
                    </button>
                    <button class="btn btn-outline" onclick="exportMarkdown()" data-tooltip="Exporter Profil (Markdown)">
                        <span class="material-icons">integration_instructions</span>
                    </button>
                     <button class="btn btn-outline" onclick="exportFullMarkdown()" data-tooltip="Exporter Canevas Complet (Markdown)">
                        <span class="material-icons">list_alt</span>
                    </button>
                </div>
            </div>


            <!-- Bloc Améliorations (collecte de suggestions) -->
            <div class="action-group">
                <span class="action-group-title">AMÉLIORATIONS</span>
                <div class="btn-row">
                    <button class="btn btn-outline" onclick="openSuggestionsModal()" data-tooltip="Proposer une amélioration (export local)">
                        <span class="material-icons">feedback</span>
                    </button>
                </div>
            </div>
            <!-- Bloc Aide -->
            <div class="action-group">
                <span class="action-group-title">Aide</span>
                <div class="btn-row">
<button class="btn btn-outline" onclick="openHelpModal()" data-tooltip="Guide d'utilisation">
                        <span class="material-icons">help</span>
                    </button>
                    <button class="btn btn-outline" onclick="openInfoModal()" data-tooltip="À propos">
                        <span class="material-icons">info</span>
                    </button>
                </div>
            </div>
            
            <!-- Hidden Input for loading files -->
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadData(this)">
        </div>
    </header>

    <div class="container">
        <form id="personaForm" class="canvas-grid">

            <!-- 1. IDENTITÉ -->
            <div class="card">
                <h2><span class="material-icons">badge</span> Identité</h2>
                <div class="card-desc">Profil administratif et personnel.</div>
                
                <!-- Base -->
                <div class="form-group">
                    <label>Prénom</label>
                    <input type="text" placeholder="Ex: Julie" id="name">
                </div>
                <div class="form-group">
                    <label>Niveau d'enseignement</label>
                    <select id="level">
                        <option value="">Sélectionner...</option>
                        <option value="Maternelle">Maternelle</option>
                        <option value="Élémentaire">Élémentaire</option>
                        <option value="Collège">Collège</option>
                        <option value="Lycée">Lycée / Lycée Pro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Discipline (si 2nd degré)</label>
                    <input type="text" placeholder="Ex: Histoire-Géo, Maths..." id="discipline">
                </div>
                
                <div class="form-group">
                    <label>Statut</label>
                    <select id="status">
                        <option value="">Sélectionner...</option>
                        <option value="Titulaire">Titulaire</option>
                        <option value="Contractuel">Contractuel</option>
                        <option value="Stagiaire">Stagiaire (ESPE/INSPE)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Années d'expérience</label>
                    <input type="text" placeholder="Ex: 5 ans, Débutant..." id="experience">
                </div>

                <!-- Context Guyane -->
                <div class="guyane-context">
                    <span class="guyane-label">Spécifique Guyane</span>
                    <div class="form-group">
                        <label>Origine & Mobilité</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="radio" name="origin" value="Muté"> Mutation depuis Métropole/DOM</label>
                            <label class="checkbox-item"><input type="radio" name="origin" value="Local"> Recrutement local</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ancienneté sur le territoire</label>
                        <select id="seniority">
                            <option value="">Sélectionner...</option>
                            <option value="Arrivant">Arrive tout juste (< 1 an)</option>
                            <option value="Installé">1 à 3 ans</option>
                            <option value="Ancien">Plus de 3 ans / Natif</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 2. CONTEXTE D'EXERCICE -->
            <div class="card">
                <h2><span class="material-icons">place</span> Localisation & classe</h2>
                <div class="card-desc">Environnement et conditions d'exercice.</div>
                
                <!-- Champ texte libre (Détails) en premier et plus large (textarea) -->
                <div class="form-group">
                    <label>Détails</label>
                    <textarea id="contextDetails" placeholder="Détails"></textarea>
                </div>

                <!-- Base -->
                <div class="form-group">
                    <label>Type d'établissement</label>
                    <input type="text" placeholder="Ex: École de quartier..." id="schoolType">
                </div>
                <div class="suggestions-panel">
                    <div class="form-group">
                        <label>Profil général de la classe</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="heterogeneity"> Hétérogénéité scolaire</label>
                            <label class="checkbox-item"><input type="checkbox" id="climate"> Gestion de classe difficile</label>
                            <!-- Nouveaux ajouts -->
                            <label class="checkbox-item"><input type="checkbox" id="multilevel"> Classe à double ou triple niveau</label>
                            <label class="checkbox-item"><input type="checkbox" id="overcrowded"> Classe surchargée / Faible effectif</label>
                            <label class="checkbox-item"><input type="checkbox" id="inclusion"> Élèves à besoins particuliers (ULIS, EBEP)</label>
                            <label class="checkbox-item"><input type="checkbox" id="social"> Précarité sociale des familles</label>
                            <label class="checkbox-item"><input type="checkbox" id="turnover_students"> Fort turnover des élèves</label>
                        </div>
                    </div>
                </div>

                <!-- Context Guyane -->
                <div class="guyane-context">
                    <span class="guyane-label">Spécifique Guyane</span>
                    <div class="form-group">
                        <label>Localisation & Isolement</label>
                        <select id="location">
                            <option value="">Sélectionner...</option>
                            <option value="Urbain">Zone Urbaine / Littoral (Cayenne, Kourou...)</option>
                            <option value="Fleuve">Commune Isolée / Fleuve (Accès avion/pirogue)</option>
                            <option value="Site">Site Isolé (Hameau reculé)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Réalités Terrain</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="allophone"> Élèves allophones / Plurilinguisme fort</label>
                            <label class="checkbox-item"><input type="checkbox" id="heat"> Ventilation HS / Chaleur extrême</label>
                            <label class="checkbox-item"><input type="checkbox" id="power"> Coupures électricité / Net HS</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. COMPÉTENCES NUMÉRIQUES -->
            <div class="card">
                <h2><span class="material-icons">devices</span> Numérique</h2>
                <div class="card-desc">Équipement et compétences technologiques.</div>
                
                <!-- Champ texte libre (Détails) en premier et plus large -->
                <div class="form-group">
                    <label>Détails</label>
                    <textarea id="digitalDetails" placeholder="Détails"></textarea>
                </div>
                <!-- Base -->
                <div class="suggestions-panel">
                    <div class="form-group">
                        <label>Outils & Usages</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="office"> Bureautique (Word/PPT)</label>
                            <label class="checkbox-item"><input type="checkbox" id="institution"> Outils Institutionnels (ENT, Pronote)</label>
                            <label class="checkbox-item"><input type="checkbox" id="smartphone"> Smartphone only</label>
                            <!-- New items -->
                            <label class="checkbox-item"><input type="checkbox" id="no_computer"> Pas d'ordi perso / Partage équipement</label>
                            <label class="checkbox-item"><input type="checkbox" id="basic_training"> Besoin formation bases (fichiers, mails)</label>
                            <label class="checkbox-item"><input type="checkbox" id="paper_only"> Privilégie le papier / Réticent numérique</label>
                            <label class="checkbox-item"><input type="checkbox" id="social_watch"> Veille via réseaux sociaux (Insta/TikTok)</label>
                            <label class="checkbox-item"><input type="checkbox" id="ai_curious"> Curieux/Utilisateur IA générative</label>
                            <label class="checkbox-item"><input type="checkbox" id="cloud_academic"> Utilise le cloud académique (Nuage/Apps)</label>
                        </div>
                    </div>
                </div>

                <!-- Context Guyane -->
                <div class="guyane-context">
                    <span class="guyane-label">Spécifique Guyane</span>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="systemD"> Solutions de contournement numériques (ressources hors ligne, partage de connexion)</label>
                        <label class="checkbox-item"><input type="checkbox" id="fracture"> Fracture numérique (matériel)</label>
                        <label class="checkbox-item"><input type="checkbox" id="fracture_skills"> Fracture numérique (Compétences insuffisantes)</label>
                    </div>
                </div>
            </div>

            <!-- 4. MOTIVATIONS -->
            <div class="card">
                <h2><span class="material-icons">psychology</span> Motivations</h2>
                <div class="card-desc">Besoins et attentes vis-à-vis de la formation.</div>
                
                <!-- Champ texte libre (Détails) en premier et plus large -->
                <div class="form-group">
                    <label>Détails</label>
                    <textarea id="motivationDetails" placeholder="Détails"></textarea>
                </div>
                <!-- Base -->
                <div class="suggestions-panel">
                    <div class="form-group">
                        <label>Pourquoi se former ?</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="classManagement"> Gestion de classe / Autorité</label>
                            <label class="checkbox-item"><input type="checkbox" id="security"> Préparation aux concours</label>
                            <label class="checkbox-item"><input type="checkbox" id="time"> Gain de temps (Ressources prêtes)</label>
                            <!-- Nouveaux ajouts -->
                            <label class="checkbox-item"><input type="checkbox" id="innovation"> Tester de nouvelles approches (Ludification, etc.)</label>
                            <label class="checkbox-item"><input type="checkbox" id="wellbeing"> Climat de classe / Bien-être</label>
                            <label class="checkbox-item"><input type="checkbox" id="mutation"> Évolution de carrière/perspectives</label>
                            <label class="checkbox-item"><input type="checkbox" id="project"> Monter un projet (Sortie, échange)</label>
                        </div>
                    </div>
                </div>

                <!-- Context Guyane -->
                <div class="guyane-context">
                    <span class="guyane-label">Spécifique Guyane</span>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="fls"> FLS</label>
                        <label class="checkbox-item"><input type="checkbox" id="isolation"> Rompre l'isolement géographique</label>
                    </div>
                </div>
            </div>

            <!-- 5. FREINS -->
            <div class="card">
                <h2><span class="material-icons">warning</span> Freins</h2>
                <div class="card-desc">Obstacles potentiels à l'apprentissage.</div>
                
                <!-- Champ texte libre (Détails) en premier et plus large -->
                <div class="form-group">
                    <label>Détails</label>
                    <textarea id="obstacleDetails" placeholder="Détails"></textarea>
                </div>
                <!-- Base -->
                <div class="suggestions-panel">
                    <div class="form-group">
                        <label>Obstacles à la formation</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="workload"> Charge de travail</label>
                            <!-- Nouveaux ajouts -->
                            <label class="checkbox-item"><input type="checkbox" id="training_gap"> Offre de formation inadaptée</label>
                            <label class="checkbox-item"><input type="checkbox" id="logistics"> Transport / Logistique (Accès formation)</label>
                            <label class="checkbox-item"><input type="checkbox" id="language_barrier"> Barrière de la langue (Enseignant/Élèves)</label>
                        </div>
                    </div>
                </div>

                <!-- Context Guyane -->
                <div class="guyane-context">
                    <span class="guyane-label">Spécifique Guyane</span>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="internet"> Connexion domicile instable/inexistante</label>
                        <label class="checkbox-item"><input type="checkbox" id="turnover"> Faible motivation</label>
                        <label class="checkbox-item"><input type="checkbox" id="jetlag"> Décalage horaire (si formateur métropole)</label>
                    </div>
                </div>
            </div>

            <!-- 6. PRÉFÉRENCES (FORMAT) -->
            <div class="card">
                <h2><span class="material-icons">headphones</span> Format</h2>
                <div class="card-desc">Modalités pédagogiques préférées.</div>
                
                <!-- Champ texte libre (Détails) en premier et plus large -->
                <div class="form-group">
                    <label>Détails</label>
                    <textarea id="formatDetails" placeholder="Détails"></textarea>
                </div>
                <!-- Base -->
                <div class="suggestions-panel">
                    <div class="form-group">
                        <label>Formats préférés</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="checkbox" id="micro"> Micro-learning (5-10 min)</label>
                            <label class="checkbox-item"><input type="checkbox" id="mobile"> Mobile Learning</label>
                            <!-- Nouveaux ajouts -->
                            <label class="checkbox-item"><input type="checkbox" id="visio"> Visio-conférence (Synchrones)</label>
                            <label class="checkbox-item"><input type="checkbox" id="hybrid"> Hybride (Présentiel + Distanciel)</label>
                            <label class="checkbox-item"><input type="checkbox" id="tutoring"> Tutorat / Accompagnement individuel</label>
                            <label class="checkbox-item"><input type="checkbox" id="resources"> Banque de ressources libre accès</label>
                        </div>
                    </div>
                </div>

                <!-- Context Guyane -->
                <div class="guyane-context">
                    <span class="guyane-label">Spécifique Guyane</span>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="offline"> Mode "Hors-ligne" (Téléchargement)</label>
                        <label class="checkbox-item"><input type="checkbox" id="whatsapp"> WhatsApp (Faible débit / Informalité)</label>
                        <label class="checkbox-item"><input type="checkbox" id="peer"> Pair-à-pair local (Témoignages crédibles)</label>
                    </div>
                </div>
            </div>

            <!-- 7. SCÉNARIO TYPE (Full Width) -->
            <div class="card full-width">
                <h2><span class="material-icons">edit_note</span> Scénario / Journée Type</h2>
                <div class="card-desc">Déroulé d'une journée type et disponibilités.</div>
                <div class="form-group">
                    <label>Racontez sa journée pour identifier les créneaux disponibles et les contraintes techniques.</label>
                    <textarea id="scenario" placeholder="Ex: Finit la classe à 13h à cause de la chaleur. Pas de réseau le soir..."></textarea>
                </div>
            </div>

        </form>
    </div>

    <footer>
        <p>François Jourde & Jacques Dubois (2026) • CC BY-SA<br>
        Code disponible sur <a href="https://github.com/jourde/artefacts" target="_blank" style="color: inherit;">https://github.com/jourde/artefacts</a></p>
    </footer>

    <!-- Modal Help (Ignored in PDF) -->
    <div id="helpModal" class="modal" data-html2canvas-ignore="true">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn" onclick="closeHelpModal()">&times;</span>
            <h2 style="border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 15px;">Guide d'utilisation</h2>
            
            <div style="font-size: 0.95rem; line-height: 1.6; color: #334155;">
<p><strong>1. Objectif</strong><br>
Ce canevas sert à décrire un profil type (persona) afin de concevoir des formations réellement adaptées aux besoins, motivations, contraintes et contextes d’exercice.</p>

<p><strong>2. Basculer les vues (en haut de page)</strong><br>
Deux interrupteurs pilotent l’affichage :
<ul style="margin-top: 5px; margin-bottom: 10px;">
    <li><strong>Standard / <span style="color: #059669; font-weight: bold;">Guyane</span> :</strong> active les items spécifiques au contexte guyanais (isolement, climat, logistique fleuve, multilinguisme, etc.).</li>
    <li><strong>Suggestions :</strong> affiche (ou masque) d’un seul coup les listes de cases à cocher “Suggestions” dans tous les blocs.</li>
</ul>
</p>

<p><strong>3. Renseigner le persona</strong><br>
<ul>
    <li><strong>Texte libre :</strong> décrivez les éléments qualitatifs (exemples, anecdotes, précisions de contexte).</li>
    <li><strong>Suggestions (cases à cocher) :</strong> activez l’interrupteur <strong>Suggestions</strong> pour faire apparaître les options, puis cochez ce qui correspond au profil.</li>
</ul>
</p>

<p><strong>4. Import & Export</strong><br>
Le bloc <strong>IMPORT & EXPORT</strong> regroupe les actions de partage et de sauvegarde :
<ul>
    <li><strong><span class="material-icons" style="font-size: 14px; vertical-align: middle;">save</span> Sauvegarder (.json)</strong> : enregistre l’état du formulaire (y compris les interrupteurs) pour le reprendre plus tard.</li>
    <li><strong><span class="material-icons" style="font-size: 14px; vertical-align: middle;">upload_file</span> Charger une sauvegarde (.json)</strong> : recharge un fichier précédemment sauvegardé.</li>
    <li><strong><span class="material-icons" style="font-size: 14px; vertical-align: middle;">picture_as_pdf</span> PDF</strong> : génère une fiche persona imprimable/partageable.</li>
    <li><strong><span class="material-icons" style="font-size: 14px; vertical-align: middle;">integration_instructions</span> Markdown</strong> : produit un texte structuré, utile pour copier-coller dans un assistant IA afin de générer un scénario ou un plan de formation contextualisé.</li>
</ul>
</p>

<p style="margin-top: 12px;"><strong>Note</strong><br>
Cet outil est un <strong>prototype non officiel</strong> : n’hésitez pas à partager vos retours et suggestions d’amélioration.</p>
            </div>
        </div>
    </div>

    
    <!-- Modal Suggestions (Ignored in PDF) -->
    <div id="suggestionsModal" class="modal" data-html2canvas-ignore="true">
        <div class="modal-content" style="max-width: 720px;">
            <span class="close-btn" onclick="closeSuggestionsModal()">&times;</span>
            <h2 style="border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 15px;">Proposer une amélioration</h2>

            <div style="font-size: 0.95rem; line-height: 1.6; color: #334155;">
                <p style="margin-top: 0;">
                    Cet espace permet de proposer des améliorations sur le contenu ou l’interface. Les suggestions sont stockées localement dans votre navigateur et peuvent être exportées en fichier (JSON) afin de les partager.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: end; margin: 14px 0;">
                    <div>
                        <label for="suggestionCategory" style="display:block; font-weight: 600; margin-bottom: 6px;">Catégorie</label>
                        <select id="suggestionCategory" class="input" style="width: 100%;">
                            <option value="Contenu des blocs">Contenu des blocs</option>
                            <option value="Libellés / vocabulaire">Libellés / vocabulaire</option>
                            <option value="Suggestions proposées">Suggestions proposées</option>
                            <option value="Ergonomie / interface">Ergonomie / interface</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div>
                        <label for="suggestionPriority" style="display:block; font-weight: 600; margin-bottom: 6px;">Priorité</label>
                        <select id="suggestionPriority" class="input" style="width: 100%;">
                            <option value="À discuter">À discuter</option>
                            <option value="Faible">Faible</option>
                            <option value="Moyenne">Moyenne</option>
                            <option value="Élevée">Élevée</option>
                        </select>
                    </div>
                </div>

                <div style="margin: 12px 0;">
                    <label for="suggestionText" style="display:block; font-weight: 600; margin-bottom: 6px;">Suggestion</label>
                    <textarea id="suggestionText" class="input" rows="5" style="width: 100%; resize: vertical;" placeholder="Décrivez votre proposition de manière précise (ex. libellé à modifier, option à ajouter/supprimer, clarification à apporter, etc.)."></textarea>
                    <div style="font-size: 0.82rem; color: #64748b; margin-top: 6px;">
                        Merci d’éviter toute donnée personnelle. Objectif : améliorer le contenu et l’ergonomie.
                    </div>
                </div>

                <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 14px;">
                    <button class="btn btn-primary" onclick="addSuggestion()">
                        <span class="material-icons" style="vertical-align: middle;">add</span>
                        Ajouter
                    </button>
                    <button class="btn btn-outline" onclick="exportSuggestions()" id="exportSuggestionsBtn">
                        <span class="material-icons" style="vertical-align: middle;">download</span>
                        Exporter les suggestions
                    </button>
                    <button class="btn btn-reset" onclick="clearSuggestions()" id="clearSuggestionsBtn" data-tooltip="Supprimer toutes les suggestions locales">
                        <span class="material-icons">delete</span>
                    </button>
                    <span id="suggestionsCount" style="margin-left: auto; font-weight: 600; color:#0f172a;">0 suggestion</span>
                </div>

                <div style="margin-top: 14px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: #f8fafc;">
                    <div style="font-weight: 700; margin-bottom: 6px;">Partager le fichier</div>
                    <div style="font-size: 0.92rem; color:#334155;">
                        Après export, merci de partager le fichier <strong>JSON</strong> (par exemple en pièce jointe dans un e-mail ou via votre canal habituel) afin de contribuer à l’amélioration du prototype.
                    </div>
                </div>

                <div id="suggestionsList" style="margin-top: 14px;"></div>
            </div>
        </div>
    </div>


<!-- Modal Info (Ignored in PDF) -->
    <div id="infoModal" class="modal" data-html2canvas-ignore="true">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInfoModal()">&times;</span>
            <h2>À propos</h2>
            <p>Cet outil permet de modéliser les besoins, motivations et contraintes des personnels d'éducation afin de concevoir des formations adaptées.</p>
            <p>Ce document est un prototype non officiel, partagé à des fins de collecte de suggestions d’amélioration.</p>
            <p><strong>Traitement local :</strong> toutes les données restent sur votre navigateur, rien n'est envoyé en ligne.</p>
            <div class="modal-footer">
                F. Jourde & J. Dubois (2026) • CC BY-SA
            </div>
        </div>
    </div>

    <script>
        const toggle = document.getElementById('contextToggle');
        const body = document.body;
        const suggestionsToggle = document.getElementById('suggestionsToggle');
        const infoModal = document.getElementById('infoModal');
        const helpModal = document.getElementById('helpModal');
        const suggestionsModal = document.getElementById('suggestionsModal');

        // Suggestions storage (local only)
        const SUGGESTIONS_STORAGE_KEY = 'persona_guyane_suggestions_v1';
        let suggestions = [];

        function loadSuggestionsFromStorage() {
            try {
                const raw = localStorage.getItem(SUGGESTIONS_STORAGE_KEY);
                suggestions = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(suggestions)) suggestions = [];
            } catch (e) {
                suggestions = [];
            }
        }

        function saveSuggestionsToStorage() {
            try {
                localStorage.setItem(SUGGESTIONS_STORAGE_KEY, JSON.stringify(suggestions));
            } catch (e) {
                // Ignore storage errors (private browsing, quota, etc.)
            }
        }

        // Toggle logic
        toggle.addEventListener('change', function() {
            if(this.checked) {
                body.classList.add('show-context');
            } else {
                body.classList.remove('show-context');
            }
        });

        

        // Suggestions (affichage global)
        suggestionsToggle.addEventListener('change', function() {
            if (this.checked) {
                body.classList.add('show-suggestions');
            } else {
                body.classList.remove('show-suggestions');
            }
        });

        // Save Functionality
        function saveData() {
            const data = {
                contextToggle: toggle.checked,
                suggestionsToggle: suggestionsToggle.checked,
                fields: {}
            };

            // Capture standard inputs with IDs
            document.querySelectorAll('[id]').forEach(el => {
                if(el.id === 'contextToggle') return; // Handled separately
                if(el.id === 'suggestionsToggle') return; // Handled separately
                if(el.id === 'fileInput') return; // Skip hidden input

                if(el.type === 'checkbox') {
                    data.fields[el.id] = el.checked;
                } else if (el.value !== undefined) {
                    data.fields[el.id] = el.value;
                }
            });

            // Capture Radio Buttons (by Name)
            const radioNames = new Set();
            document.querySelectorAll('input[type="radio"]').forEach(el => radioNames.add(el.name));
            radioNames.forEach(name => {
                const checked = document.querySelector(`input[name="${name}"]:checked`);
                if(checked) {
                    data.fields['radio:' + name] = checked.value;
                }
            });

            // Create JSON File
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            // Trigger Download
            const a = document.createElement('a');
            a.href = url;
            a.download = "persona_guyane.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Load Functionality
        function loadData(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    restoreForm(data);
                } catch(err) {
                    alert("Erreur lors de la lecture du fichier : " + err);
                }
                // Reset input so same file can be selected again if needed
                input.value = '';
            };
            reader.readAsText(file);
        }

        function restoreForm(data) {
            // Restore Toggle
            toggle.checked = !!data.contextToggle;
            if(toggle.checked) body.classList.add('show-context');
            else body.classList.remove('show-context');

            // Restore Suggestions Toggle
            suggestionsToggle.checked = !!data.suggestionsToggle;
            if(suggestionsToggle.checked) body.classList.add('show-suggestions');
            else body.classList.remove('show-suggestions');

            // Restore Fields
            for (const [key, value] of Object.entries(data.fields)) {
                if(key.startsWith('radio:')) {
                    const name = key.split(':')[1];
                    const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
                    if(radio) radio.checked = true;
                } else {
                    const el = document.getElementById(key);
                    if(el) {
                        if(el.type === 'checkbox') el.checked = value;
                        else el.value = value;
                    }
                }
            }
        }

        // PDF Export Functionality
        function exportPDF() {
            // Retrieve name for filename
            const nameValue = document.getElementById('name').value;
            const safeName = nameValue ? nameValue.replace(/[^a-z0-9]/gi, '_') : 'persona';
            
            const element = document.body;
            // Use cached html2pdf to prevent multiple initializations if library supports it
            // Basic usage creates new instance each time, which is fine for click events.
            const opt = {
                margin:       10, // mm
                filename:     `Canevas_${safeName}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate PDF
            // The data-html2canvas-ignore attributes in HTML will prevent buttons/controls from appearing
            if (typeof html2pdf !== 'undefined') {
                html2pdf().set(opt).from(element).save();
            } else {
                alert("La librairie PDF n'est pas encore chargée. Veuillez réessayer dans un instant.");
            }
        }

        // Markdown Export Functionality - Optimized for performance
        function exportMarkdown() {
            const name = document.getElementById('name').value || 'Persona';
            let md = `# Profil Persona : ${name}\n`;
            md += `> Contexte : Éducation nationale / Académie de Guyane\n`;
            md += `> Date : ${new Date().toLocaleDateString()}\n\n`;

            const isGuyane = document.getElementById('contextToggle').checked;

            // Helper to process a specific DOM element (form-group or checkbox-group)
            // Using textContent instead of innerText to avoid costly reflows
            const processElement = (el) => {
                let text = '';
                
                if (el.classList.contains('form-group')) {
                    const labelEl = el.querySelector('label');
                    // Optimization: textContent is faster than innerText
                    const label = labelEl ? labelEl.textContent.replace(':','').trim() : 'Champ';
                    
                    // Text/Select/Textarea
                    const simpleInput = el.querySelector('input[type="text"], select, textarea');
                    if (simpleInput) {
                        const val = simpleInput.value.trim();
                        if (val && val !== 'Sélectionner...') {
                            text += `- **${label}** : ${val}\n`;
                        }
                    }

                    // Radio/Checkbox inside form-group
                    const inputs = el.querySelectorAll('input[type="radio"], input[type="checkbox"]');
                    if (inputs.length > 0) {
                        if (inputs[0].type === 'radio') {
                            const checked = el.querySelector('input:checked');
                            if (checked) {
                                // Optimization: textContent
                                text += `- **${label}** : ${checked.parentElement.textContent.trim()}\n`;
                            }
                        } else {
                            // Checkboxes
                            const checked = el.querySelectorAll('input:checked');
                            if (checked.length > 0) {
                                text += `- **${label}** :\n`;
                                checked.forEach(c => {
                                    // Optimization: textContent
                                    text += `  - ${c.parentElement.textContent.trim()}\n`;
                                });
                            }
                        }
                    }
                } else if (el.classList.contains('checkbox-group')) {
                    // Standalone checkbox group (no label wrapper)
                    const checked = el.querySelectorAll('input:checked');
                    checked.forEach(c => {
                        // Optimization: textContent
                        text += `- ${c.parentElement.textContent.trim()}\n`;
                    });
                }
                return text;
            };

            document.querySelectorAll('.card').forEach(card => {
                // Title cleaning
                // Using textContent. Note: Material icon text might be included in textContent.
                // We must handle the removal carefully.
                let title = "";
                const h2 = card.querySelector('h2');
                if (h2) {
                     // Clone to safely manipulate without DOM reflows on the live page
                    // Optimization: Use childNodes filtering instead of cloneNode to improve performance
                    title = Array.from(h2.childNodes)
                        .filter(n => n.nodeType === Node.TEXT_NODE)
                        .map(n => n.textContent.trim())
                        .join(' ').trim();
                }

                let sectionContent = '';

                // Iterate children
                Array.from(card.children).forEach(child => {
                    if (child.tagName === 'H2') return;
                    if (child.tagName === 'BUTTON') return; // Skip toggle buttons
                    if (child.classList.contains('card-desc')) return; // Skip description

                    if (child.classList.contains('guyane-context')) {
                        if (isGuyane) {
                            let contextContent = '';
                            Array.from(child.children).forEach(ctxChild => {
                                contextContent += processElement(ctxChild);
                            });
                            if (contextContent) {
                                sectionContent += `\n> **Contexte Guyane**\n${contextContent}`;
                            }
                        }
                    } else if (child.classList.contains('suggestions-panel')) {
                        // Handle wrapped content
                        Array.from(child.children).forEach(innerChild => {
                            sectionContent += processElement(innerChild);
                        });
                    } else {
                        sectionContent += processElement(child);
                    }
                });

                if (sectionContent.trim()) {
                    md += `## ${title}\n${sectionContent}\n`;
                }
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Persona_${name.replace(/\s+/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Full Canvas Export - Lists all options
        function exportFullMarkdown() {
            const name = document.getElementById('name').value || 'Persona';
            let md = `# Canevas Persona Complet : ${name}\n`;
            md += `> Contexte : Éducation nationale / Académie de Guyane\n`;
            md += `> Date : ${new Date().toLocaleDateString()}\n\n`;

            const isGuyane = document.getElementById('contextToggle').checked;

            const processElementFull = (el) => {
                let text = '';
                
                if (el.classList.contains('form-group')) {
                    const labelEl = el.querySelector('label');
                    const label = labelEl ? labelEl.textContent.replace(':','').trim() : 'Champ';
                    
                    // Text/Select/Textarea
                    const simpleInput = el.querySelector('input[type="text"], select, textarea');
                    if (simpleInput) {
                        // Handle Select specifically to list options
                        if (simpleInput.tagName === 'SELECT') {
                            text += `- **${label}** :\n`;
                            Array.from(simpleInput.options).forEach(opt => {
                                if (opt.value) { // skip placeholder
                                    const isSelected = opt.selected;
                                    text += `  - [${isSelected ? 'x' : ' '}] ${opt.text}\n`;
                                }
                            });
                        } else {
                            // Text/Textarea
                            const val = simpleInput.value.trim();
                            text += `- **${label}** : ${val || '(vide)'}\n`;
                        }
                    }

                    // Radio/Checkbox inside form-group
                    const inputs = el.querySelectorAll('input[type="radio"], input[type="checkbox"]');
                    if (inputs.length > 0) {
                        text += `- **${label}** :\n`;
                        inputs.forEach(input => {
                            const isChecked = input.checked;
                            const itemLabel = input.parentElement.textContent.trim();
                            text += `  - [${isChecked ? 'x' : ' '}] ${itemLabel}\n`;
                        });
                    }
                } else if (el.classList.contains('checkbox-group')) {
                    // Standalone checkbox group
                    const inputs = el.querySelectorAll('input[type="checkbox"]');
                    inputs.forEach(input => {
                        const isChecked = input.checked;
                        const itemLabel = input.parentElement.textContent.trim();
                        text += `- [${isChecked ? 'x' : ' '}] ${itemLabel}\n`;
                    });
                }
                return text;
            };

            document.querySelectorAll('.card').forEach(card => {
                let title = "";
                const h2 = card.querySelector('h2');
                if (h2) {
                    // Optimization: Use childNodes filtering instead of cloneNode to improve performance
                    title = Array.from(h2.childNodes)
                        .filter(n => n.nodeType === Node.TEXT_NODE)
                        .map(n => n.textContent.trim())
                        .join(' ').trim();
                }

                let sectionContent = '';

                Array.from(card.children).forEach(child => {
                    if (child.tagName === 'H2') return;
                    if (child.tagName === 'BUTTON') return; // Skip toggle buttons
                    if (child.classList.contains('card-desc')) return; // Skip description

                    if (child.classList.contains('guyane-context')) {
                        // ALWAYS process Guyane context for full export, regardless of toggle
                        let contextContent = '';
                        Array.from(child.children).forEach(ctxChild => {
                            contextContent += processElementFull(ctxChild);
                        });
                        if (contextContent) {
                            sectionContent += `\n> **Contexte Guyane**\n${contextContent}`;
                        }
                    } else if (child.classList.contains('suggestions-panel')) {
                        // Process suggestions regardless of visibility in full export
                         Array.from(child.children).forEach(innerChild => {
                            sectionContent += processElementFull(innerChild);
                        });
                    } else {
                        sectionContent += processElementFull(child);
                    }
                });

                if (sectionContent.trim()) {
                    md += `## ${title}\n${sectionContent}\n`;
                }
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Persona_Complet_${name.replace(/\s+/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetForm() {
            document.getElementById('personaForm').reset();
            toggle.checked = false;
            body.classList.remove('show-context');

            suggestionsToggle.checked = false;
            body.classList.remove('show-suggestions');
        }

        
        // Suggestions (local collection)
        function pluraliseSuggestion(n) {
            return n === 1 ? 'suggestion' : 'suggestions';
        }

        function formatDateTimeISO(dt) {
            const pad = (x) => String(x).padStart(2, '0');
            return dt.getFullYear()
                + '-' + pad(dt.getMonth() + 1)
                + '-' + pad(dt.getDate())
                + ' ' + pad(dt.getHours())
                + ':' + pad(dt.getMinutes());
        }

        function renderSuggestions() {
            const countEl = document.getElementById('suggestionsCount');
            const listEl = document.getElementById('suggestionsList');
            if (!countEl || !listEl) return;

            const n = suggestions.length;
            countEl.textContent = `${n} ${pluraliseSuggestion(n)}`;

            if (n === 0) {
                listEl.innerHTML = '<div style="color:#64748b; font-size:0.92rem; margin-top: 8px;">Aucune suggestion enregistrée pour le moment.</div>';
                return;
            }

            const items = suggestions
                .slice()
                .sort((a, b) => (b.created_at || 0) - (a.created_at || 0))
                .map(s => {
                    const created = s.created_at ? formatDateTimeISO(new Date(s.created_at)) : '';
                    const cat = s.category || '—';
                    const prio = s.priority || '—';
                    const text = (s.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `
                        <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; background:#ffffff; margin-top:10px;">
                            <div style="display:flex; gap:10px; align-items: baseline; flex-wrap: wrap;">
                                <span style="font-weight:700; color:#0f172a;">${cat}</span>
                                <span style="color:#64748b;">•</span>
                                <span style="font-weight:600; color:#334155;">Priorité : ${prio}</span>
                                ${created ? `<span style="margin-left:auto; color:#64748b; font-size:0.85rem;">${created}</span>` : `<span style="margin-left:auto;"></span>`}
                            </div>
                            <div style="margin-top:8px; white-space:pre-wrap; color:#0f172a;">${text}</div>
                            <div style="margin-top:10px; display:flex; justify-content:flex-end;">
                                <button class="btn btn-reset" onclick="removeSuggestion('${s.id}')" data-tooltip="Supprimer cette suggestion">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </div>`;
                })
                .join('');

            listEl.innerHTML = items;
        }

        function openSuggestionsModal() {
            loadSuggestionsFromStorage();
            renderSuggestions();
            suggestionsModal.style.display = "block";
        }

        function closeSuggestionsModal() {
            suggestionsModal.style.display = "none";
        }

        function addSuggestion() {
            const catEl = document.getElementById('suggestionCategory');
            const prioEl = document.getElementById('suggestionPriority');
            const textEl = document.getElementById('suggestionText');

            if (!textEl) return;

            const text = (textEl.value || '').trim();
            if (!text) {
                alert('Merci de saisir une suggestion avant de l’ajouter.');
                return;
            }

            const suggestion = {
                id: 'sug_' + Math.random().toString(36).slice(2) + '_' + Date.now(),
                created_at: Date.now(),
                category: catEl ? catEl.value : 'Autre',
                priority: prioEl ? prioEl.value : 'À discuter',
                text: text
            };

            loadSuggestionsFromStorage();
            suggestions.push(suggestion);
            saveSuggestionsToStorage();

            textEl.value = '';
            renderSuggestions();
        }

        function removeSuggestion(id) {
            loadSuggestionsFromStorage();
            suggestions = suggestions.filter(s => s.id !== id);
            saveSuggestionsToStorage();
            renderSuggestions();
        }

        function clearSuggestions() {
            const ok = confirm('Supprimer toutes les suggestions enregistrées localement ?');
            if (!ok) return;
            suggestions = [];
            saveSuggestionsToStorage();
            renderSuggestions();
        }

        function exportSuggestions() {
            loadSuggestionsFromStorage();

            if (!suggestions || suggestions.length === 0) {
                alert('Aucune suggestion à exporter.');
                return;
            }

            const payload = {
                tool: 'Canevas de personas — Guyane (prototype)',
                exported_at: new Date().toISOString(),
                suggestions: suggestions
            };

            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const dt = new Date();
            const pad = (x) => String(x).padStart(2, '0');
            const filename = `suggestions-persona-guyane-${dt.getFullYear()}${pad(dt.getMonth() + 1)}${pad(dt.getDate())}-${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // Modal Logic
        function openInfoModal() {
            infoModal.style.display = "block";
        }

        function closeInfoModal() {
            infoModal.style.display = "none";
        }

        function openHelpModal() {
            helpModal.style.display = "block";
        }

        function closeHelpModal() {
            helpModal.style.display = "none";
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == infoModal) {
                infoModal.style.display = "none";
            }
            if (event.target == helpModal) {
                helpModal.style.display = "none";
            }
            if (event.target == suggestionsModal) {
                suggestionsModal.style.display = "none";
            }
        }
    </script>
</body>
</html>
