<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Formation à Distance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sortable Library for reordering dimensions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: grab;
            margin-top: -8px; 
            box-shadow: 0 2px 4px 0 rgba(79, 70, 229, 0.4);
            border: 2px solid white;
            transition: transform 0.1s ease;
        }

        input[type=range]::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent;
            border-radius: 9999px;
        }

        input[type=range]:focus {
            outline: none;
        }

        /* Sortable ghost styles */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #f1f5f9;
            border: 2px dashed #94a3b8;
        }
        
        .panel-content {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .panel-content.open {
            max-height: 2000px;
            opacity: 1;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        /* Slider tooltip (appears on hover/move) */
        .slider-tooltip {
            position: absolute;
            z-index: 30;
            top: -10px;
            left: 50%;
            transform: translate(-50%, -120%);
            pointer-events: none;
            white-space: nowrap;
            padding: 6px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
        }
        .slider-tooltip.hidden { display: none; }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-6">
            <div class="mb-2 md:mb-0">
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Configuration Pédagogique</h1>
                <p class="text-slate-500 mt-1 whitespace-nowrap overflow-x-auto">Définissez les dimensions de votre dispositif de formation</p>

                <!-- Formation field -->
                <div class="mt-5">
                    <label for="formationInput" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Formation :</label>
                    <input id="formationInput" type="text" placeholder="Nom de la formation" class="mt-2 w-full md:w-[420px] bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300" />
                </div>
            </div>
            
            <div class="flex flex-wrap gap-4 items-end">
                <!-- Toolbar -->
                <div class="flex flex-col gap-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1">Outils</span>
                    <div class="flex items-center bg-white border border-slate-200 rounded-xl p-1.5 gap-1 shadow-sm h-[52px]">
                         <button onclick="showAboutModal()" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-2" title="À propos">
                            <span class="material-icons-round text-xl">info</span>
                            <span class="text-sm font-semibold hidden md:inline">Infos</span>
                        </button>
                        <button onclick="togglePanel('orderPanel')" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-2" title="Réorganiser">
                            <span class="material-icons-round text-xl">sort</span>
                            <span class="text-sm font-semibold hidden md:inline">Ordre</span>
                        </button>
                        
                        <!-- Experimental Alert Button -->
                        <button id="btnAlerts" onclick="toggleAlerts()" class="text-slate-400 hover:text-amber-600 hover:bg-amber-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-2" title="Activer l'analyse (Expérimental)">
                            <span class="material-icons-round text-xl">science</span>
                            <span class="text-sm font-semibold hidden md:inline">Analyse</span>
                            <span id="betaBadge" class="hidden md:inline-flex items-center justify-center bg-slate-100 text-slate-500 text-[9px] font-bold px-1.5 py-0.5 rounded border border-slate-200 uppercase tracking-wide">Beta</span>
                        </button>


<!-- Save / Load -->
<button onclick="saveState()" class="text-slate-600 hover:text-emerald-600 hover:bg-emerald-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-2" title="Sauvegarder">
    <span class="material-icons-round text-xl">save</span>
    <span class="text-sm font-semibold hidden md:inline">Sauvegarde</span>
</button>
<button onclick="triggerLoad()" class="text-slate-600 hover:text-sky-600 hover:bg-sky-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-2" title="Charger une sauvegarde">
    <span class="material-icons-round text-xl">folder_open</span>
    <span class="text-sm font-semibold hidden md:inline">Charger</span>
</button>
<button onclick="exportMarkdown()" class="text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-xl transition-colors flex items-center gap-2" title="Exporter en Markdown">
    <span class="material-icons-round text-xl">description</span>
    <span class="text-sm font-semibold hidden md:inline">Export MD</span>
</button>

<input id="loadFileInput" type="file" accept="application/json" class="hidden" onchange="loadStateFromFile(event)">

                        <div class="w-px bg-slate-200 h-6 mx-1"></div>
                        <button onclick="showResetModal()" class="text-slate-600 hover:text-rose-600 hover:bg-rose-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-2" title="Réinitialiser">
                            <span class="material-icons-round text-xl">restart_alt</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Custom Reset Modal -->
        <div id="resetModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden" onclick="if(event.target === this) hideResetModal()">
            <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full mx-4 border border-slate-200 animate-[slideIn_0.2s_ease-out]">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-rose-100 p-3 rounded-full text-rose-600">
                        <span class="material-icons-round">refresh</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-900">Réinitialiser ?</h3>
                </div>
                <p class="text-slate-600 text-sm mb-6">Tous les curseurs reviendront à leur position centrale (50%).</p>
                <div class="flex gap-3 justify-end">
                    <button onclick="hideResetModal()" class="px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Annuler</button>
                    <button onclick="performReset()" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition-colors">Réinitialiser</button>
                </div>
            </div>
        </div>

        <!-- About Modal -->
        <div id="aboutModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden" onclick="if(event.target === this) hideAboutModal()">
            <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-md w-full mx-4 border border-slate-200 relative animate-[slideIn_0.2s_ease-out]">
                <button onclick="hideAboutModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-icons-round">close</span>
                </button>
                
                <h3 class="text-lg font-bold text-slate-900 mb-5 flex items-center gap-2">
                    <span class="material-icons-round text-indigo-500">info</span>
                    À propos
                </h3>
                
                <div class="space-y-4">
                    <p class="text-sm text-slate-600 leading-relaxed">
                        Cet outil permet de visualiser et d'équilibrer les 6 dimensions structurelles de votre dispositif de formation.
                    </p>
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                        <p class="text-xs text-indigo-800 leading-relaxed italic">
                            Inspiré de : Docq et al. 2023. Enseigner à distance: 5 balises pour vous lancer. Presses universitaires de Louvain.
                        </p>
                    </div>
                    <p class="text-xs text-slate-500 flex items-center gap-2">
                        <span class="material-icons-round text-sm text-emerald-500">verified_user</span>
                        Traitement local : toutes les données restent sur votre navigateur, rien n'est envoyé en ligne.
                    </p>
                    <div class="text-[10px] text-slate-400 border-t border-slate-100 pt-3 mt-4">
                        F. Jourde & J. Dubois (2026) • CC BY-SA
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel: Reorder Dimensions -->
        <div id="orderPanel" class="mb-6 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden panel-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="material-icons-round text-indigo-500">unfold_more</span>
                        Priorité des dimensions
                    </h3>
                    <button onclick="togglePanel('orderPanel')" class="text-slate-400 hover:text-slate-600 p-1 rounded-full"><span class="material-icons-round">close</span></button>
                </div>
                <p class="text-sm text-slate-500 mb-6">Glissez-déposez pour réorganiser l'affichage.</p>
                <ul id="sortableList" class="space-y-2 max-w-2xl">
                    <!-- List items generated by JS -->
                </ul>
                <div class="mt-6 pt-6 border-t border-slate-100">
                    <button onclick="applyOrder()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">
                        Mettre à jour l'affichage
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <!-- Main Content Area: Sliders -->
            <div class="lg:col-span-2 space-y-4" id="slidersContainer">
                <!-- Sliders dynamically injected here -->
            </div>

            <!-- Sidebar: Alerts -->
            <div class="space-y-6 lg:sticky lg:top-8">
                 <div id="alertsContainer" class="hidden">
                     <!-- Alerts injected here by JS -->
                 </div>
            </div>
        </div>

        <!-- Footer Section -->
        <footer class="mt-16 pt-8 border-t border-slate-200 text-center">
            <p class="text-xs text-slate-500 font-medium">François Jourde & Jacques Dubois (2026) — CC BY SA</p>
            <p class="text-xs text-slate-400 mt-2">
                Code disponible sur 
                <a href="https://github.com/jourde/artefacts" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:text-indigo-600 hover:underline transition-colors">
                    https://github.com/jourde/artefacts
                </a>
            </p>
        </footer>

    </div>

    <script>
        // --- State Management ---
        let alertsEnabled = false; // Default off (Experimental)
        
        const dimensions = [
            {
                id: 0,
                leftTitle: "PRÉSENCE",
                rightTitle: "DISTANCE",
                leftDesc: "Unité de lieu et de temps.",
                rightDesc: "Flexibilité géographique.",
                value: 50,
                tickLabels: [
                    "Présentiel",
                    "Majoritairement présentiel",
                    "Hybride",
                    "Majoritairement à distance",
                    "À distance"
                ]
            },
            {
                id: 1,
                leftTitle: "PETIT GROUPE",
                rightTitle: "GRAND GROUPE",
                leftDesc: "Suivi individuel.",
                rightDesc: "Massification.",
                value: 50,
                tickLabels: [
                    "Petit groupe",
                    "Groupe restreint",
                    "Groupe moyen",
                    "Groupe large",
                    "Grand groupe"
                ]
            },
            {
                id: 2,
                leftTitle: "ASYNCHRONE",
                rightTitle: "SYNCHRONE",
                leftDesc: "Temps différé.",
                rightDesc: "Temps réel.",
                value: 50,
                tickLabels: [
                    "Auto-rythmé",
                    "Asynchrone guidé",
                    "Mixte",
                    "Synchrone ponctuel",
                    "Synchrone"
                ]
            },
            {
                id: 3,
                leftTitle: "INDIVIDUEL",
                rightTitle: "COLLABORATIF",
                leftDesc: "Travaux personnels.",
                rightDesc: "Co-construction.",
                value: 50,
                tickLabels: [
                    "Individuel",
                    "Individuel + échanges",
                    "Alterné",
                    "Travail en équipe",
                    "Collaboratif"
                ]
            },
            {
                id: 4,
                leftTitle: "APPROPRIATION",
                rightTitle: "PRODUCTION",
                leftDesc: "Ressources.",
                rightDesc: "Création.",
                value: 50,
                tickLabels: [
                    "Appropriation",
                    "Réutilisation",
                    "Adaptation",
                    "Création",
                    "Production"
                ]
            },
            {
                id: 5,
                leftTitle: "ACCOMPAGNEMENT",
                rightTitle: "SANS ACCOMPAGNEMENT",
                leftDesc: "Guidage fort.",
                rightDesc: "Autonomie.",
                value: 50,
                tickLabels: [
                    "Accompagnement fort",
                    "Accompagnement régulier",
                    "Accompagnement ponctuel",
                    "Autonomie guidée",
                    "Sans accompagnement"
                ]
            }
        ];

        
        function tickLabelsFor(dim) {
            // 5 crans réguliers (0/25/50/75/100) avec libellés spécifiques à chaque dimension.
            // Priorité au paramétrage explicite (dim.tickLabels). Repli sur une logique générique.
            if (dim && Array.isArray(dim.tickLabels) && dim.tickLabels.length === 5) return dim.tickLabels;

            const left = dim?.leftTitle || "Gauche";
            const right = dim?.rightTitle || "Droite";
            return [left, `Intermédiaire (${left})`, "Équilibré", `Intermédiaire (${right})`, right];
        }

let currentOrder = dimensions.map(d => d.id);

        

// --- Save / Load (local + fichier) ---
const STORAGE_KEY = "config_pedagogique_state_v1";

function buildState() {
    const formation = (document.getElementById('formationInput')?.value || '').trim();
    return {
        version: 1,
        savedAt: new Date().toISOString(),
        formation,
        alertsEnabled: !!alertsEnabled,
        currentOrder: Array.isArray(currentOrder) ? currentOrder.slice() : dimensions.map(d => d.id),
        dimensions: dimensions.map(d => ({ id: d.id, value: d.value }))
    };
}

function applyState(state) {
    if (!state || typeof state !== "object") return;

    // Formation label
    if (typeof state.formation === 'string') {
        const input = document.getElementById('formationInput');
        if (input) input.value = state.formation;
    }

    // Order
    if (Array.isArray(state.currentOrder) && state.currentOrder.length === dimensions.length) {
        const ids = new Set(dimensions.map(d => d.id));
        const isValid = state.currentOrder.every(x => ids.has(x));
        if (isValid) currentOrder = state.currentOrder.slice();
    }

    // Values
    if (Array.isArray(state.dimensions)) {
        state.dimensions.forEach(item => {
            const dim = dimensions.find(d => d.id === item.id);
            if (dim && Number.isFinite(parseInt(item.value))) {
                const v = Math.max(0, Math.min(100, parseInt(item.value)));
                dim.value = v;
            }
        });
    }

    // Alerts flag + UI
    if (typeof state.alertsEnabled === "boolean") {
        alertsEnabled = state.alertsEnabled;
        setAlertsUI(alertsEnabled);
    }

    renderSliders();
    checkAlerts();
}

function saveState() {
    const state = buildState();

    // 1) LocalStorage (simple reprise)
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
        console.warn("Impossible d'écrire dans localStorage :", e);
    }

    // 2) Téléchargement d'un fichier JSON (backup transportable)
    try {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const dateTag = new Date().toISOString().slice(0,19).replace(/[:T]/g, "-");
        a.href = url;
        a.download = `configuration-formation_${dateTag}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    } catch (e) {
        console.warn("Impossible de télécharger la sauvegarde :", e);
    }
}

function exportMarkdown() {
    const state = buildState();

    // Dimensions affichées dans l'ordre courant
    const orderedDims = (Array.isArray(state.currentOrder) ? state.currentOrder : dimensions.map(d => d.id))
        .map(id => dimensions.find(d => d.id === id))
        .filter(Boolean);

    // Helpers
    const clamp100 = (n) => {
        const v = Number(n);
        return Number.isFinite(v) ? Math.max(0, Math.min(100, v)) : 50;
    };

    const nearestTickIndex = (value) => Math.round(value / 25); // 0..4
    const safe = (v) => (v === null || v === undefined) ? "" : String(v);
    const esc = (s) => safe(s).replace(/\|/g, "\\|").trim();

    const getTickLabel = (dim, value) => {
        const idx = nearestTickIndex(value);
        if (Array.isArray(dim?.tickLabels) && dim.tickLabels.length) {
            return safe(dim.tickLabels[idx] ?? dim.tickLabels[dim.tickLabels.length - 1] ?? "");
        }
        // Fallback: labels dérivés des titres gauche/droite
        const left = safe(dim?.leftTitle);
        const right = safe(dim?.rightTitle);
        const derived = [
            left,
            left ? `Plutôt ${left}` : "",
            "Équilibré",
            right ? `Plutôt ${right}` : "",
            right
        ];
        return derived[idx] || "";
    };

    const getDimensionName = (dim) => {
        const title = safe(dim?.title).trim();
        if (title) return title;

        // Fallback: dériver un nom lisible à partir des deux pôles
        const left = safe(dim?.leftTitle).trim();
        const right = safe(dim?.rightTitle).trim();
        if (left && right) return `${left}/${right}`;
        if (left) return left;
        if (right) return right;

        return "—";
    };

    // Construire le Markdown
    const now = new Date();
    const lines = [];

    lines.push(`# Dispositif de formation`);
    lines.push(``);
    lines.push(`## Informations`);
    lines.push(`- **Formation :** ${state.formation ? esc(state.formation) : "—"}`);
    lines.push(`- **Date :** ${now.toLocaleString('fr-FR')}`);
    lines.push(``);
    lines.push(`## Dimensions`);
    lines.push(``);
    lines.push(`| Dimension | Cran |`);
    lines.push(`|---|---|`);

    orderedDims.forEach((dim) => {
        const value = clamp100(dim?.value);
        const tickLabel = getTickLabel(dim, value);
        const name = getDimensionName(dim);

        const tickStr = tickLabel ? tickLabel : "—";
        lines.push(`| **${esc(name)}** | ${esc(tickStr)} |`);
    });


    const md = lines.join('\n');

    // Télécharger le fichier .md
    try {
        const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        const safeName = (state.formation || "dispositif-formation").toLowerCase()
            .replace(/[^a-z0-9àâçéèêëîïôûùüÿñæœ\s-]/gi, '')
            .trim()
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .slice(0, 60) || "dispositif-formation";

        const dateTag = now.toISOString().slice(0,10); // YYYY-MM-DD
        a.href = url;
        a.download = `${safeName}_${dateTag}.md`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    } catch (e) {
        console.warn("Impossible d’exporter en Markdown :", e);
        alert("L’export Markdown a échoué sur ce navigateur.");
    }
}



function triggerLoad() {
    // Priorité au fichier (explicite), mais on tente aussi une restauration locale si le user annule.
    const input = document.getElementById("loadFileInput");
    if (input) {
        input.value = "";
        input.click();
    }
}

function loadStateFromFile(event) {
    const file = event?.target?.files?.[0];
    if (!file) {
        // User a annulé : tentative de reprise locale
        loadStateFromLocal();
        return;
    }

    const reader = new FileReader();
    reader.onload = function() {
        try {
            const state = JSON.parse(String(reader.result || ""));
            applyState(state);
            // On garde aussi en local pour la prochaine fois
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
        } catch (e) {
            alert("Fichier de sauvegarde invalide.");
            console.error(e);
        }
    };
    reader.readAsText(file, "utf-8");
}

function loadStateFromLocal() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        applyState(state);
    } catch (e) {
        console.warn("Impossible de charger la sauvegarde locale :", e);
    }
}

// --- Core Functions ---

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const willOpen = !panel.classList.contains('open');
            
            if (willOpen) {
                if(panelId === 'orderPanel') renderSortableList();
                panel.classList.add('open');
            } else {
                panel.classList.remove('open');
            }
        }

        
function setAlertsUI(enabled) {
    const btn = document.getElementById('btnAlerts');
    const badge = document.getElementById('betaBadge');
    const container = document.getElementById('alertsContainer');

    if (!btn || !badge) return;

    if (enabled) {
        btn.classList.remove('text-slate-400');
        btn.classList.add('text-amber-600', 'bg-amber-50');
        badge.classList.remove('bg-slate-100', 'text-slate-500', 'border-slate-200');
        badge.classList.add('bg-amber-100', 'text-amber-700', 'border-amber-200');
        checkAlerts();
    } else {
        btn.classList.add('text-slate-400');
        btn.classList.remove('text-amber-600', 'bg-amber-50');
        badge.classList.add('bg-slate-100', 'text-slate-500', 'border-slate-200');
        badge.classList.remove('bg-amber-100', 'text-amber-700', 'border-amber-200');
        if (container) container.classList.add('hidden');
    }
}

function toggleAlerts() {
    alertsEnabled = !alertsEnabled;
    setAlertsUI(alertsEnabled);
}

        function renderSliders() {
            const container = document.getElementById("slidersContainer");
            let html = "";
            
            currentOrder.forEach(id => {
                const dim = dimensions.find(d => d.id === id);
                
                html += `
                <div id="slider-card-${dim.id}" class="slider-card bg-white px-4 py-3 rounded-xl shadow-sm border border-slate-200 transition-all duration-300">
                    <div class="flex justify-between items-end mb-1">
                        <div class="w-5/12">
                            <h3 class="text-xs font-bold text-slate-800 leading-none">${dim.leftTitle}</h3>
                            <p class="text-[9px] text-slate-400 leading-tight mt-0.5">${dim.leftDesc}</p>
                        </div>
                        
                        <div class="w-2/12 flex justify-center pb-0.5">
                             <button onclick="resetDim(${dim.id})" class="text-slate-200 hover:text-indigo-500 transition-colors p-1" title="Recentrer">
                                <span class="material-icons-round text-base">center_focus_strong</span>
                            </button>
                        </div>

                        <div class="w-5/12 text-right">
                            <h3 class="text-xs font-bold text-slate-800 leading-none">${dim.rightTitle}</h3>
                            <p class="text-[9px] text-slate-400 leading-tight mt-0.5">${dim.rightDesc}</p>
                        </div>
                    </div>
                    
                    <div class="relative h-5 flex items-center mt-1">
                        <!-- Track Background -->
                        <div class="absolute w-full h-1 bg-slate-100 rounded-full overflow-hidden top-1/2 -translate-y-1/2">
                            <div class="w-1/2 h-full bg-slate-200/40"></div>
                        </div>

                        <!-- Graduations / Ticks -->
                        <div class="absolute w-full h-2 flex justify-between px-[1px] pointer-events-none top-1/2 -translate-y-1/2">
                            <div class="w-[1px] h-full bg-slate-300"></div> <!-- 0 -->
                            <div class="w-[1px] h-1 bg-slate-300 self-center"></div> <!-- 25 -->
                            <div class="w-[2px] h-full bg-slate-400"></div> <!-- 50 -->
                            <div class="w-[1px] h-1 bg-slate-300 self-center"></div> <!-- 75 -->
                            <div class="w-[1px] h-full bg-slate-300"></div> <!-- 100 -->
                        </div>

                        <!-- Input -->
                        <input type="range" min="0" max="100" step="25" value="${dim.value}" id="range-${dim.id}"
                            class="w-full relative z-10 appearance-none bg-transparent" 
                            oninput="updateVal(${dim.id}, this.value); showTooltip(${dim.id}, this, true)" onmousemove="showTooltip(${dim.id}, this)" onmouseenter="showTooltip(${dim.id}, this)" onmouseleave="hideTooltip(${dim.id})" ontouchstart="showTooltip(${dim.id}, this, true)" ontouchmove="showTooltip(${dim.id}, this, true)" ontouchend="hideTooltip(${dim.id})" onfocus="showTooltip(${dim.id}, this, true)" onblur="hideTooltip(${dim.id})">
                    
                        <!-- Tooltip (hover/move) -->
                        <div id="tooltip-${dim.id}" class="slider-tooltip hidden"></div>
</div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateVal(id, val) {
            const dim = dimensions.find(d => d.id === id);
            if (dim) {
                dim.value = parseInt(val, 10);

                checkAlerts();
            }
        }

        
function showTooltip(id, inputEl, forceVisible = false) {
    const dim = dimensions.find(d => d.id === id);
    if (!dim || !inputEl) return;

    // Determine label for current value (including during drag)
    const value = parseInt(inputEl.value, 10);
    const labels = tickLabelsFor(dim);
    const idx = Math.max(0, Math.min(4, Math.round(value / 25)));
    const label = labels[idx] ?? `${value}`;

    const tooltip = document.getElementById(`tooltip-${id}`);
    if (!tooltip) return;

    tooltip.textContent = label;
    tooltip.classList.remove('hidden');

    // Position tooltip above the thumb using percentage
    const min = parseInt(inputEl.min || "0", 10);
    const max = parseInt(inputEl.max || "100", 10);
    const pct = (value - min) / (max - min || 1);

    // Use input width to set a pixel position inside the parent (relative container)
    const inputRect = inputEl.getBoundingClientRect();
    const parent = inputEl.parentElement; // relative container
    const parentRect = parent.getBoundingClientRect();

    const x = (inputRect.left - parentRect.left) + pct * inputRect.width;

    tooltip.style.left = `${x}px`;

    // On keyboard focus, we also show tooltip (forceVisible = true)
    if (forceVisible) {
        // keep visible; hide on blur/mouseleave
    }
}

function hideTooltip(id) {
    const tooltip = document.getElementById(`tooltip-${id}`);
    if (tooltip) tooltip.classList.add('hidden');
}

function resetDim(id) {
            const dim = dimensions.find(d => d.id === id);
            if(dim) {
                dim.value = 50;
                const input = document.getElementById(`range-${id}`);
                if(input) input.value = 50;
                updateVal(id, 50);
            }
        }
        
        function checkAlerts() {
            const container = document.getElementById('alertsContainer');
            if (!container) return;

            // If feature disabled, ensure hidden and exit
            if (!alertsEnabled) {
                container.classList.add('hidden');
                return;
            }

            const d = dimensions.map(dim => dim.value);
            const alerts = [];

            // Helpers: Left < 50, Right > 50
            const isL = (idx) => d[idx] < 50;
            const isR = (idx) => d[idx] > 50;

            // Mappings:
            // 0: PRESENCE (L) / DISTANCE (R)
            // 1: PETIT (L) / GRAND (R)
            // 2: ASYNC (L) / SYNC (R)
            // 3: INDIV (L) / COLLAB (R)
            // 4: APPRO (L) / PROD (R)
            // 5: ACCOMP (L) / SANS ACCOMP (R)

            // Alert Rules
            if (isR(2) && isR(5)) alerts.push("<strong>Synchrone + Sans accompagnement :</strong> les sessions en temps réel sont difficiles à gérer sans présence du/de la formateur·rice pour animer et réguler.");
            if (isR(3) && isL(2)) alerts.push("<strong>Collaboratif + Asynchrone :</strong> la collaboration en temps différé nécessite des outils et consignes très structurés pour coordonner le travail de groupe.");
            if (isR(4) && isR(5)) alerts.push("<strong>Production + Sans accompagnement :</strong> les étudiant·es qui doivent produire leurs propres ressources ont souvent besoin de guidage et de feedback.");
            if (isR(2) && isR(4) && isR(3) && isR(5)) alerts.push("<strong>Synchrone + Production + Collaboratif + Sans accompagnement :</strong> configuration très exigeante qui demande beaucoup d'autonomie et de compétences aux étudiant·es.");
            if (isR(2) && isR(4) && isR(3) && isL(5)) alerts.push("<strong>Synchrone + Production + Collaboratif (avec accompagnement) :</strong> cette combinaison demande une coordination importante en temps réel.");
            if (isR(1) && isL(5)) alerts.push("<strong>Grand groupe + Accompagnement fort :</strong> l'accompagnement individualisé devient difficile avec un grand nombre de participants.");
            if (isR(0) && isR(2)) alerts.push("<strong>Distance + Synchrone :</strong> les sessions synchrones à distance nécessitent des outils fiables et une bonne connexion.");
            if (isR(0) && isR(1) && isR(5)) alerts.push("<strong>Distance + Grand groupe + Sans accompagnement :</strong> les étudiant·es peuvent facilement se sentir isolés et perdus.");
            if (isR(0) && isR(3)) alerts.push("<strong>Distance + Collaboratif :</strong> la collaboration à distance nécessite des outils spécifiques et une organisation rigoureuse.");
            if (isR(1) && isR(3)) alerts.push("<strong>Grand groupe + Collaboratif :</strong> organiser du travail collaboratif avec un grand nombre de participants demande une structuration forte.");
            if (isR(1) && isR(4)) alerts.push("<strong>Grand groupe + Production :</strong> accompagner la production de ressources par un grand groupe est exigeant.");
            if (isL(0) && isL(2)) alerts.push("<strong>Présence + Asynchrone :</strong> cette combinaison est peu cohérente. Si les étudiant·es sont en présence, privilégiez les interactions synchrones.");

            if (alerts.length > 0) {
                container.innerHTML = `
                    <div class="bg-amber-50 rounded-2xl p-5 border border-amber-100 shadow-sm animate-[slideIn_0.3s_ease-out]">
                        <h3 class="text-sm font-bold text-amber-800 mb-3 flex items-center gap-2">
                            <span class="material-icons-round text-amber-500">warning_amber</span>
                            Points de vigilance (${alerts.length})
                        </h3>
                        <div class="space-y-3">
                            ${alerts.map(a => `<div class="text-xs text-amber-900 bg-white/60 p-2 rounded border border-amber-100/50">${a}</div>`).join('')}
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            } else {
                container.innerHTML = '';
                container.classList.add('hidden');
            }
        }

        // --- Reordering Logic ---
        function renderSortableList() {
            const list = document.getElementById("sortableList");
            list.innerHTML = "";
            currentOrder.forEach(id => {
                const dim = dimensions.find(d => d.id === id);
                const li = document.createElement("li");
                li.className = "flex items-center gap-3 bg-white p-4 rounded-xl border border-slate-200 cursor-grab active:cursor-grabbing hover:border-indigo-300 transition-colors shadow-sm";
                li.setAttribute("data-id", dim.id);
                li.innerHTML = `
                    <span class="material-icons-round text-slate-300">drag_handle</span>
                    <span class="font-bold text-slate-700 text-sm flex-1">${dim.leftTitle} / ${dim.rightTitle}</span>
                `;
                list.appendChild(li);
            });

            if (typeof Sortable !== 'undefined') {
                new Sortable(list, {
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    handle: 'li'
                });
            }
        }

        function applyOrder() {
            const listItems = document.querySelectorAll("#sortableList li");
            const newOrder = [];
            listItems.forEach(item => {
                newOrder.push(parseInt(item.getAttribute("data-id")));
            });
            currentOrder = newOrder;
            renderSliders();
            togglePanel('orderPanel');
        }

        // --- Modal & Reset UI ---
        function showResetModal() { document.getElementById('resetModal').classList.remove('hidden'); }
        function hideResetModal() { document.getElementById('resetModal').classList.add('hidden'); }
        
        function showAboutModal() { document.getElementById('aboutModal').classList.remove('hidden'); }
        function hideAboutModal() { document.getElementById('aboutModal').classList.add('hidden'); }

        function performReset() {
            dimensions.forEach(d => {
                d.value = 50;
            });
            renderSliders();
            checkAlerts();
            hideResetModal();
        }

        // --- Initial Load ---
        // Rendu robuste : ne dépend pas de window.onload (qui peut être écrasé par d'autres scripts)
        // et tolère les erreurs de lecture localStorage.
        document.addEventListener('DOMContentLoaded', () => {
            // Démarrage en position neutre : les curseurs restent au milieu par défaut (50%)
            // Aucun chargement automatique depuis le navigateur afin d’éviter de réinjecter une ancienne configuration.
            try { renderSliders(); } catch (e) { console.error(e); }

            try { setAlertsUI(alertsEnabled); } catch (e) {}
            try { checkAlerts(); } catch (e) {}
        });
    </script>
</body>
</html>
