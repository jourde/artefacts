import React, { useState } from 'react';
import { Plus, Trash2, Download, ChevronDown, ChevronUp } from 'lucide-react';

const PersonaCanvas = () => {
  const [personas, setPersonas] = useState([
    {
      id: 1,
      nom: '',
      role: '',
      age: '',
      contexte: '',
      competencesNumeriques: [],
      motivations: [],
      freins: [],
      besoins: [],
      objectifs: [],
      scenarioUtilisation: [],
      autresCompetences: '',
      autresMotivations: '',
      autresFreins: '',
      autresBesoins: '',
      autresObjectifs: '',
      autresScenarios: '',
      expandedSections: {}
    }
  ]);

  const options = {
    competencesNumeriques: [
      'Maîtrise du courriel et du traitement de texte',
      'Utilise les réseaux sociaux personnels',
      'À l\'aise avec les visioconférences (Zoom, Teams)',
      'Utilise des plateformes pédagogiques (Moodle, Classroom)',
      'Crée des contenus numériques (vidéos, présentations)',
      'Maîtrise les outils collaboratifs (documents partagés)',
      'Peu à l\'aise avec la technologie',
      'Autodidacte en numérique'
    ],
    motivations: [
      'Moderniser ses pratiques pédagogiques',
      'Mieux engager les élèves',
      'Gagner du temps dans la préparation',
      'Développer de nouvelles compétences',
      'S\'adapter aux attentes institutionnelles',
      'Partager avec des collègues',
      'Améliorer le suivi des élèves',
      'Répondre aux besoins des élèves à distance'
    ],
    freins: [
      'Manque de temps',
      'Appréhension face à la technologie',
      'Connexion internet instable',
      'Équipement informatique insuffisant',
      'Manque de formation initiale',
      'Charge de travail déjà élevée',
      'Résistance au changement',
      'Manque de soutien technique'
    ],
    besoins: [
      'Tutoriels pas à pas',
      'Support technique réactif',
      'Temps de pratique guidée',
      'Communauté d\'entraide',
      'Ressources clés en main',
      'Formation courte et flexible',
      'Exemples concrets dans sa discipline',
      'Accompagnement personnalisé'
    ],
    objectifs: [
      'Maîtriser une plateforme d\'apprentissage en ligne',
      'Créer des contenus interactifs',
      'Animer des classes virtuelles',
      'Évaluer à distance',
      'Gérer un environnement hybride',
      'Différencier l\'enseignement avec le numérique',
      'Collaborer en ligne avec les collègues',
      'Communiquer efficacement avec les familles'
    ],
    scenarioUtilisation: [
      'Préfère se former le soir après les cours',
      'A besoin de modules courts (15-20 min)',
      'Veut pouvoir revenir sur les contenus',
      'Apprend mieux en pratiquant',
      'Préfère les sessions synchrones avec formateur',
      'A besoin de flexibilité totale',
      'Souhaite échanger avec des pairs',
      'Préfère les ressources vidéo aux textes'
    ]
  };

  const addPersona = () => {
    const newId = Math.max(...personas.map(p => p.id), 0) + 1;
    setPersonas([...personas, {
      id: newId,
      nom: '',
      role: '',
      age: '',
      contexte: '',
      competencesNumeriques: [],
      motivations: [],
      freins: [],
      besoins: [],
      objectifs: [],
      scenarioUtilisation: [],
      autresCompetences: '',
      autresMotivations: '',
      autresFreins: '',
      autresBesoins: '',
      autresObjectifs: '',
      autresScenarios: '',
      expandedSections: {}
    }]);
  };

  const deletePersona = (id) => {
    if (personas.length > 1) {
      setPersonas(personas.filter(p => p.id !== id));
    }
  };

  const updatePersona = (id, field, value) => {
    setPersonas(personas.map(p => 
      p.id === id ? { ...p, [field]: value } : p
    ));
  };

  const toggleCheckbox = (id, field, option) => {
    setPersonas(personas.map(p => {
      if (p.id === id) {
        const currentValues = p[field];
        const newValues = currentValues.includes(option)
          ? currentValues.filter(v => v !== option)
          : [...currentValues, option];
        return { ...p, [field]: newValues };
      }
      return p;
    }));
  };

  const toggleSection = (id, section) => {
    setPersonas(personas.map(p => {
      if (p.id === id) {
        return {
          ...p,
          expandedSections: {
            ...p.expandedSections,
            [section]: !p.expandedSections[section]
          }
        };
      }
      return p;
    }));
  };

  const exportData = () => {
    const dataStr = JSON.stringify(personas, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'personas-formation-hybride.json';
    link.click();
  };

  const CheckboxSection = ({ persona, field, title, options: sectionOptions }) => {
    const isExpanded = persona.expandedSections[field];
    
    return (
      <div className="border border-gray-200 rounded-lg p-4">
        <button
          onClick={() => toggleSection(persona.id, field)}
          className="w-full flex justify-between items-center mb-2"
        >
          <h3 className="text-sm font-semibold text-gray-700">{title}</h3>
          {isExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
        </button>
        
        {isExpanded && (
          <div className="space-y-2 mt-3">
            {sectionOptions.map((option, idx) => (
              <label key={idx} className="flex items-start gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                <input
                  type="checkbox"
                  checked={persona[field].includes(option)}
                  onChange={() => toggleCheckbox(persona.id, field, option)}
                  className="mt-1 w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500"
                />
                <span className="text-sm text-gray-700">{option}</span>
              </label>
            ))}
            <div className="mt-3">
              <input
                type="text"
                value={persona[`autres${field.charAt(0).toUpperCase()}${field.slice(1)}`] || ''}
                onChange={(e) => updatePersona(persona.id, `autres${field.charAt(0).toUpperCase()}${field.slice(1)}`, e.target.value)}
                placeholder="Autre (précisez)..."
                className="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
          <h1 className="text-3xl font-bold text-indigo-900 mb-2">
            Canevas de Personas
          </h1>
          <p className="text-gray-600 mb-4">
            Conception de formation hybride pour le personnel éducatif
          </p>
          <div className="flex gap-3">
            <button
              onClick={addPersona}
              className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              <Plus size={20} />
              Ajouter un persona
            </button>
            <button
              onClick={exportData}
              className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
            >
              <Download size={20} />
              Exporter
            </button>
          </div>
        </div>

        {personas.map((persona, index) => (
          <div key={persona.id} className="bg-white rounded-lg shadow-lg p-8 mb-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-indigo-800">
                Persona {index + 1}
              </h2>
              {personas.length > 1 && (
                <button
                  onClick={() => deletePersona(persona.id)}
                  className="text-red-600 hover:text-red-800 transition"
                >
                  <Trash2 size={24} />
                </button>
              )}
            </div>

            <div className="space-y-6">
              {/* Section Identité */}
              <div className="bg-indigo-50 p-4 rounded-lg">
                <h3 className="text-lg font-semibold text-indigo-900 mb-4">Identité</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Nom du persona
                    </label>
                    <input
                      type="text"
                      value={persona.nom}
                      onChange={(e) => updatePersona(persona.id, 'nom', e.target.value)}
                      placeholder="Ex: Marie Dubois"
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Rôle / Fonction
                    </label>
                    <input
                      type="text"
                      value={persona.role}
                      onChange={(e) => updatePersona(persona.id, 'role', e.target.value)}
                      placeholder="Ex: Enseignante de maths"
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Âge / Ancienneté
                    </label>
                    <input
                      type="text"
                      value={persona.age}
                      onChange={(e) => updatePersona(persona.id, 'age', e.target.value)}
                      placeholder="Ex: 45 ans, 20 ans"
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                </div>
                <div className="mt-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Contexte professionnel
                  </label>
                  <textarea
                    value={persona.contexte}
                    onChange={(e) => updatePersona(persona.id, 'contexte', e.target.value)}
                    placeholder="Ex: Établissement rural, 25 élèves par classe, ressources numériques limitées..."
                    rows="2"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  />
                </div>
              </div>

              {/* Sections à cocher */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <CheckboxSection 
                  persona={persona}
                  field="competencesNumeriques"
                  title="Compétences numériques"
                  options={options.competencesNumeriques}
                />
                <CheckboxSection 
                  persona={persona}
                  field="motivations"
                  title="Motivations"
                  options={options.motivations}
                />
                <CheckboxSection 
                  persona={persona}
                  field="freins"
                  title="Freins / Obstacles"
                  options={options.freins}
                />
                <CheckboxSection 
                  persona={persona}
                  field="besoins"
                  title="Besoins spécifiques"
                  options={options.besoins}
                />
                <CheckboxSection 
                  persona={persona}
                  field="objectifs"
                  title="Objectifs d'apprentissage"
                  options={options.objectifs}
                />
                <CheckboxSection 
                  persona={persona}
                  field="scenarioUtilisation"
                  title="Scénario d'utilisation"
                  options={options.scenarioUtilisation}
                />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default PersonaCanvas;
