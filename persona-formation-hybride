import React, { useState, useRef } from 'react';
import { 
  User, MapPin, Wifi, Monitor, Target, AlertTriangle, 
  Lightbulb, BookOpen, Printer, RefreshCw, Save 
} from 'lucide-react';

// --- DATA DEFINITIONS ---

const SECTIONS = {
  context: {
    id: 'context',
    title: '2. Contexte Ultra-Marin',
    icon: <MapPin className="w-5 h-5" />,
    options: [
      "Déplacements réguliers vers des zones isolées (fleuve, forêt)",
      "Accès internet instable ou inexistant dans certaines zones",
      "Infrastructures numériques limitées dans les établissements",
      "Distances importantes entre les sites de formation",
      "Transports difficiles (pirogue, petit avion, piste)",
      "Décalage horaire de -5h avec la France métropolitaine",
      "Difficultés pour participer à des formations synchrones avec la métropole",
      "Disponibilité limitée des formateurs métropolitains en temps réel",
      "Contraintes liées aux horaires de vol pour les déplacements inter-Guyane",
      "Public enseignant très hétérogène (métropole, Antilles, locaux)",
      "Contexte multiculturel et plurilingue",
      "Adaptation nécessaire aux réalités locales",
      "Isolement professionnel de certains enseignants",
      "Turnover important du personnel enseignant"
    ]
  },
  skills: {
    id: 'skills',
    title: '3. Compétences Numériques',
    icon: <Monitor className="w-5 h-5" />,
    options: [
      "Maîtrise du courriel et du traitement de texte",
      "Utilise les réseaux sociaux professionnels",
      "À l'aise avec les visioconférences (Zoom, Teams, Meet)",
      "Utilise des plateformes pédagogiques (Moodle, Magistère)",
      "Crée des contenus numériques (vidéos, présentations)",
      "Maîtrise les outils collaboratifs (docs partagés, tableaux blancs)",
      "Peu à l'aise avec la technologie",
      "Autodidacte en numérique"
    ]
  },
  motivations: {
    id: 'motivations',
    title: '4. Motivations',
    icon: <Target className="w-5 h-5" />,
    options: [
      "Former efficacement malgré les distances géographiques",
      "Réduire le temps de déplacement",
      "Toucher davantage d'enseignants isolés",
      "Développer de nouvelles compétences en formation à distance",
      "S'adapter aux contraintes du territoire guyanais",
      "Mutualiser les ressources avec d'autres formateurs",
      "Améliorer le suivi des enseignants formés",
      "Créer une communauté de formateurs ultra-marins"
    ]
  },
  obstacles: {
    id: 'obstacles',
    title: '5. Freins / Obstacles',
    icon: <AlertTriangle className="w-5 h-5" />,
    options: [
      "Manque de temps (déplacements chronophages)",
      "Appréhension face aux outils de formation à distance",
      "Connexion internet instable ou insuffisante",
      "Équipement informatique inadéquat (personnel ou des stagiaires)",
      "Manque de formation à l'hybridation",
      "Charge de travail déjà très élevée",
      "Résistance des enseignants à la formation à distance",
      "Manque de soutien technique local",
      "Décalage horaire compliquant les échanges avec la métropole"
    ]
  },
  needs: {
    id: 'needs',
    title: '6. Besoins Spécifiques',
    icon: <Lightbulb className="w-5 h-5" />,
    options: [
      "Tutoriels adaptés aux contraintes de connexion",
      "Support technique réactif et disponible en décalé",
      "Temps de pratique guidée en asynchrone",
      "Communauté d'entraide entre formateurs ultra-marins",
      "Ressources clés en main téléchargeables",
      "Formation courte et très flexible",
      "Exemples concrets adaptés au contexte guyanais",
      "Accompagnement personnalisé à distance"
    ]
  },
  objectives: {
    id: 'objectives',
    title: "7. Objectifs d'Apprentissage",
    icon: <BookOpen className="w-5 h-5" />,
    options: [
      "Concevoir des parcours de formation hybrides",
      "Animer des formations à distance efficaces",
      "Créer des ressources numériques réutilisables",
      "Gérer l'asynchrone dans ses formations",
      "Adapter les contenus aux contraintes de connexion",
      "Accompagner les enseignants à distance",
      "Collaborer en ligne avec d'autres formateurs",
      "Évaluer les apprentissages en formation hybride"
    ]
  },
  scenario: {
    id: 'scenario',
    title: "8. Scénario d'Utilisation",
    icon: <User className="w-5 h-5" />,
    options: [
      "Préfère se former le soir après les formations",
      "A besoin de modules courts (15-20 min)",
      "Veut pouvoir télécharger les contenus pour consultation hors ligne",
      "Apprend mieux en pratiquant",
      "Préfère les sessions synchrones adaptées au décalage horaire",
      "A besoin de flexibilité totale (déplacements imprévisibles)",
      "Souhaite échanger avec des pairs ultra-marins",
      "Préfère les ressources vidéo aux textes longs",
      "Contraintes familiales limitant la disponibilité en soirée",
      "Disponibilité irrégulière liée aux missions sur le terrain"
    ]
  }
};

export default function PersonaBuilder() {
  const [activeTab, setActiveTab] = useState('identity');
  
  const [formData, setFormData] = useState({
    name: '',
    role: '',
    age: '',
    context: '',
    selections: {
      context: [],
      skills: [],
      motivations: [],
      obstacles: [],
      needs: [],
      objectives: [],
      scenario: []
    },
    custom: {
      context: '',
      skills: '',
      motivations: '',
      obstacles: '',
      needs: '',
      objectives: '',
      scenario: ''
    }
  });

  const handleIdentityChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const toggleSelection = (sectionId, option) => {
    setFormData(prev => {
      const currentList = prev.selections[sectionId];
      const newList = currentList.includes(option)
        ? currentList.filter(item => item !== option)
        : [...currentList, option];
      
      return {
        ...prev,
        selections: {
          ...prev.selections,
          [sectionId]: newList
        }
      };
    });
  };

  const handleCustomChange = (sectionId, value) => {
    setFormData(prev => ({
      ...prev,
      custom: {
        ...prev.custom,
        [sectionId]: value
      }
    }));
  };

  const resetForm = () => {
    if (window.confirm("Voulez-vous vraiment effacer tout le formulaire ?")) {
      setFormData({
        name: '',
        role: '',
        age: '',
        context: '',
        selections: { context: [], skills: [], motivations: [], obstacles: [], needs: [], objectives: [], scenario: [] },
        custom: { context: '', skills: '', motivations: '', obstacles: '', needs: '', objectives: '', scenario: '' }
      });
    }
  };

  const handlePrint = () => {
    window.print();
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      
      {/* Navigation Header */}
      <nav className="bg-emerald-800 text-white shadow-lg sticky top-0 z-50 print:hidden">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <div className="flex items-center space-x-3">
              <MapPin className="h-6 w-6 text-emerald-300" />
              <span className="font-bold text-xl">Persona Guyane</span>
            </div>
            <div className="flex space-x-4">
              <button 
                onClick={resetForm}
                className="flex items-center space-x-2 px-3 py-2 rounded bg-emerald-700 hover:bg-emerald-600 transition text-sm"
              >
                <RefreshCw className="h-4 w-4" />
                <span className="hidden sm:inline">Réinitialiser</span>
              </button>
              <button 
                onClick={handlePrint}
                className="flex items-center space-x-2 px-4 py-2 rounded bg-white text-emerald-900 font-medium hover:bg-emerald-50 transition shadow-sm text-sm"
              >
                <Printer className="h-4 w-4" />
                <span>Imprimer / PDF</span>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* LEFT COLUMN: EDIT FORM */}
          <div className="lg:col-span-5 print:hidden space-y-6">
            
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-4 bg-slate-100 border-b border-slate-200 flex items-center space-x-2">
                <User className="text-emerald-600 w-5 h-5" />
                <h2 className="font-semibold text-slate-800">1. Identité</h2>
              </div>
              <div className="p-5 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Nom du persona</label>
                  <input 
                    type="text" 
                    name="name"
                    value={formData.name}
                    onChange={handleIdentityChange}
                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition"
                    placeholder="Ex: Jean-Pierre"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Rôle / Fonction</label>
                    <input 
                      type="text" 
                      name="role"
                      value={formData.role}
                      onChange={handleIdentityChange}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="Ex: CPC"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Âge / Ancienneté</label>
                    <input 
                      type="text" 
                      name="age"
                      value={formData.age}
                      onChange={handleIdentityChange}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="Ex: 45 ans"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Contexte professionnel</label>
                  <textarea 
                    name="context"
                    value={formData.context}
                    onChange={handleIdentityChange}
                    rows="3"
                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    placeholder="Basé à Cayenne, itinérant..."
                  />
                </div>
              </div>
            </div>

            {/* Accordion-like sections for checks */}
            <div className="space-y-4">
              {Object.values(SECTIONS).map((section) => (
                <div key={section.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                  <button 
                    onClick={() => setActiveTab(activeTab === section.id ? null : section.id)}
                    className={`w-full p-4 flex items-center justify-between text-left transition-colors ${activeTab === section.id ? 'bg-emerald-50 border-b border-emerald-100' : 'hover:bg-slate-50'}`}
                  >
                    <div className="flex items-center space-x-3">
                      <div className={`p-1.5 rounded-lg ${activeTab === section.id ? 'bg-emerald-200 text-emerald-800' : 'bg-slate-100 text-slate-500'}`}>
                        {section.icon}
                      </div>
                      <span className={`font-semibold ${activeTab === section.id ? 'text-emerald-900' : 'text-slate-700'}`}>
                        {section.title}
                      </span>
                    </div>
                    <span className="text-xs font-medium px-2 py-1 bg-slate-100 rounded-full text-slate-600">
                      {formData.selections[section.id].length} séléctionnés
                    </span>
                  </button>

                  {activeTab === section.id && (
                    <div className="p-5 bg-white animate-in slide-in-from-top-2 duration-200">
                      <div className="space-y-3">
                        {section.options.map((option, idx) => (
                          <label key={idx} className="flex items-start space-x-3 group cursor-pointer p-2 rounded-lg hover:bg-slate-50 transition">
                            <input 
                              type="checkbox"
                              checked={formData.selections[section.id].includes(option)}
                              onChange={() => toggleSelection(section.id, option)}
                              className="mt-1 h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                            />
                            <span className="text-sm text-slate-700 group-hover:text-slate-900">{option}</span>
                          </label>
                        ))}
                      </div>
                      <div className="mt-4 pt-4 border-t border-slate-100">
                        <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">
                          Autre (Spécifiez)
                        </label>
                        <textarea
                          value={formData.custom[section.id]}
                          onChange={(e) => handleCustomChange(section.id, e.target.value)}
                          className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500"
                          rows="2"
                          placeholder="Saisissez d'autres détails ici..."
                        />
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* RIGHT COLUMN: PREVIEW (And Print View) */}
          <div className="lg:col-span-7">
            <div className="sticky top-24">
              <div className="bg-white rounded-none sm:rounded-2xl shadow-xl print:shadow-none print:border-none print:w-full overflow-hidden border border-slate-200" id="persona-card">
                
                {/* Header Card */}
                <div className="bg-emerald-900 text-white p-6 sm:p-8 relative overflow-hidden">
                  <div className="absolute top-0 right-0 p-8 opacity-10">
                    <MapPin className="w-32 h-32" />
                  </div>
                  <div className="relative z-10">
                    <div className="flex flex-col sm:flex-row sm:items-end justify-between gap-4">
                      <div>
                        <h4 className="text-emerald-300 text-sm font-bold tracking-wider uppercase mb-1">
                          Persona Formation Hybride
                        </h4>
                        <h1 className="text-3xl sm:text-4xl font-bold">
                          {formData.name || <span className="opacity-50 italic">Nom du persona</span>}
                        </h1>
                        <p className="text-emerald-100 text-lg mt-1">
                          {formData.role || <span className="opacity-50 italic">Rôle / Fonction</span>}
                        </p>
                      </div>
                      <div className="text-emerald-200 text-sm sm:text-right bg-emerald-800/50 p-3 rounded-lg backdrop-blur-sm">
                        <p>{formData.age || "Âge non défini"}</p>
                        <p className="font-mono text-xs opacity-75 mt-1">Guyane Française</p>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Content Body */}
                <div className="p-6 sm:p-8 space-y-8 bg-white">
                  
                  {/* Context Block */}
                  <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                     <h3 className="text-emerald-800 font-bold flex items-center mb-3">
                        <User className="w-4 h-4 mr-2" />
                        Contexte Professionnel
                     </h3>
                     <p className="text-slate-700 italic leading-relaxed">
                       {formData.context ? `"${formData.context}"` : <span className="text-slate-400">Aucun contexte défini...</span>}
                     </p>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-8">
                    {/* Dynamic Sections Loop */}
                    {Object.values(SECTIONS).map((section) => {
                      const hasItems = formData.selections[section.id].length > 0;
                      const hasCustom = formData.custom[section.id].length > 0;
                      
                      if (!hasItems && !hasCustom) return null;

                      return (
                        <div key={section.id} className="break-inside-avoid">
                          <h3 className="text-emerald-800 font-bold border-b-2 border-emerald-100 pb-2 mb-3 flex items-center text-sm uppercase tracking-wide">
                            <span className="bg-emerald-100 text-emerald-800 p-1 rounded mr-2">
                              {section.icon}
                            </span>
                            {section.title.replace(/^\d+\.\s/, '')}
                          </h3>
                          <ul className="space-y-2">
                            {formData.selections[section.id].map((item, i) => (
                              <li key={i} className="flex items-start text-sm text-slate-700">
                                <span className="mr-2 text-emerald-500">•</span>
                                <span>{item}</span>
                              </li>
                            ))}
                            {formData.custom[section.id] && (
                              <li className="flex items-start text-sm text-slate-700 italic bg-amber-50 p-2 rounded border border-amber-100 mt-2">
                                <span className="mr-2 text-amber-500">✎</span>
                                <span>{formData.custom[section.id]}</span>
                              </li>
                            )}
                          </ul>
                        </div>
                      );
                    })}
                  </div>

                  {/* Empty State visual */}
                  {Object.values(formData.selections).every(arr => arr.length === 0) && !formData.context && (
                    <div className="text-center py-12 border-2 border-dashed border-slate-200 rounded-xl">
                      <p className="text-slate-400 mb-2">La fiche est vide.</p>
                      <p className="text-sm text-slate-400">Remplissez le formulaire à gauche pour générer le persona.</p>
                    </div>
                  )}

                </div>
                
                {/* Footer for Print */}
                <div className="bg-slate-50 p-4 border-t border-slate-200 text-center text-xs text-slate-400 flex justify-between items-center print:flex">
                  <span>Canevas de Persona • Formation Hybride Guyane</span>
                  <span>{new Date().toLocaleDateString()}</span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      
      {/* Print Styles Injection */}
      <style>{`
        @media print {
          body { background: white; }
          nav, button, .no-print { display: none !important; }
          .print\\:hidden { display: none !important; }
          .lg\\:col-span-7 { width: 100% !important; margin: 0 !important; padding: 0 !important; }
          .sticky { position: static !important; }
          .shadow-xl { shadow: none !important; box-shadow: none !important; }
          .border { border: none !important; }
          #persona-card { border: 1px solid #ccc !important; break-inside: avoid; }
        }
      `}</style>
    </div>
  );
}
